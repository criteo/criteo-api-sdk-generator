name: Push Preview OAS to ReadMe documentation repositories

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - api: MarketingSolutions
            ssh_secret: MARKETING_SOLUTIONS_PUBLIC_API_DOC_REPO_PRIVATE_KEY
            repo: marketing-solutions-public-api-doc
            oas_dest_name: criteo-api-1.json
            spec_file: marketingsolutions_preview.json
          - api: RetailMedia
            ssh_secret: RETAIL_MEDIA_PUBLIC_API_DOC_REPO_PRIVATE_KEY
            repo: retail-media-public-api-doc
            oas_dest_name: criteo-api.json
            spec_file: retailmedia_preview.json
    name: ${{ matrix.api }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup SSH Agent for git operations
        uses: webfactory/ssh-agent@v0.9.1
        with:
            ssh-private-key: ${{ secrets[matrix.ssh_secret] }}

      - name: Commit and push Preview OAS
        run: |
          git clone git@github.com:criteo/${{ matrix.repo }}.git
          cd ${{ matrix.repo }}
          PREVIEW_BRANCH=$(git branch -a | grep preview | cut -d '/' -f3)
          git checkout $PREVIEW_BRANCH
          OAS_DEST_NAME=${{ matrix.oas_dest_name }}
          OAS_DEST=reference/"$OAS_DEST_NAME"
          cp ../api-specifications/${{ matrix.spec_file }} "$OAS_DEST"
          chmod u+x ../scripts/regenerate_md_files.sh
          ../scripts/regenerate_md_files.sh "$OAS_DEST_NAME"
          git add "$OAS_DEST"
          git add reference
          git config --global user.name "update-oas-bot"
          git config --global user.email "update-oas-bot@users.noreply.github.com"
          if git commit -m "OAS auto-update"; then
            git push origin $PREVIEW_BRANCH
          else
            echo "Nothing to commit"
          fi

      - name: Send success notification
        if: ${{ success() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            status: "${{ job.status }}"
            channel: "C02J0CWR789"
            username: "sdk-generation-bot"
            text: "Autoupdate of ${{ matrix.api }} Preview OAS in Readme repo."
            icon_emoji: ":bell:"

      - name: Send failure notification
        if: ${{ failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            status: "${{ job.status }}"
            channel: "C02J0CWR789"
            username: "sdk-generation-bot"
            text: "Autoupdate of ${{ matrix.api }} Preview OAS in Readme repo failure, check <https://github.com/criteo/criteo-api-sdk-generator/actions|action results>. <!subteam^S07BSM1MDN2>."
            icon_emoji: ":x:"
